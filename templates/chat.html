<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Socketchat</title>
    <style>
      .gradient-custom {
      /* fallback for old browsers */
          background: #fccb90;

      /* Chrome 10-25, Safari 5.1-6 */
          background: -webkit-linear-gradient(to bottom right, rgba(252, 203, 144, 1), rgba(213, 126, 235, 1));

      /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
          background: linear-gradient(to bottom right, rgba(252, 203, 144, 1), rgba(213, 126, 235, 1))
      }

      .mask-custom {
          background: rgba(24, 24, 16, .2);
          border-radius: 2em;
          backdrop-filter: blur(15px);
          border: 2px solid rgba(255, 255, 255, 0.05);
          background-clip: padding-box;
          box-shadow: 10px 10px 10px rgba(46, 54, 68, 0.03);
      }
    </style>
  </head>
  <body>
    <section class="gradient-custom" style="min-height: 100vh;">
      <div class="container py-5">

      <div id="login-register-buttons">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logIn">
          Log In
        </button>
  
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#register">
          Register
        </button>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="logIn" tabindex="-1" aria-labelledby="logInLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="logInLabel">Log In</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="login-username" class="col-form-label">Username:</label>
                <input type="text" class="form-control" id="login-username">
              </div>
              <div class="mb-3">
                <label for="login-password" class="col-form-label">Password:</label>
                <input type="password" class="form-control" id="login-password">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="login()">Log In</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="register" tabindex="-1" aria-labelledby="registerLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="registerLabel">Register</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="register-username" class="col-form-label">Username:</label>
                <input type="text" class="form-control" id="register-username">
              </div>
              <div class="mb-3">
                <label for="register-firstname" class="col-form-label">First Name:</label>
                <input type="text" class="form-control" id="register-firstname">
              </div>
              <div class="mb-3">
                <label for="register-lastname" class="col-form-label">Last Name:</label>
                <input type="text" class="form-control" id="register-lastname">
              </div>
              <div class="mb-3">
                <label for="register-password" class="col-form-label">Password:</label>
                <input type="password" class="form-control" id="register-password">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="register()">Register</button>
            </div>
          </div>
        </div>
      </div>

        <div id="chatroom" style="display: none;" class="row">
    
          <div class="col-md-6 col-lg-5 col-xl-5 mb-4 mb-md-0">
    
            <h5 class="font-weight-bold mb-3 text-center text-white">Chat Rooms</h5>
    
            <div class="card mask-custom">
              <div class="card-body">
    
                <ul class="list-unstyled mb-0">
                  <li class="p-2 border-bottom" style="border-bottom: 1px solid rgba(255,255,255,.3) !important;">
                    <a href="#news" class="d-flex justify-content-between link-light" onclick="selectRoom('news')">
                      <div class="d-flex flex-row">
                        <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
                          class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                        <div class="pt-1">
                          <p class="fw-bold mb-0">news</p>
                          <p class="small text-white">All news here</p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="p-2 border-bottom" style="border-bottom: 1px solid rgba(255,255,255,.3) !important;">
                    <a href="#covid19" class="d-flex justify-content-between link-light" onclick="selectRoom('covid19')">
                      <div class="d-flex flex-row">
                        <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
                          class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                        <div class="pt-1">
                          <p class="fw-bold mb-0">covid19</p>
                          <p class="small text-white">News about COVID 19</p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li class="p-2 border-bottom" style="border-bottom: 1px solid rgba(255,255,255,.3) !important;">
                    <a href="#nodejs" class="d-flex justify-content-between link-light" onclick="selectRoom('nodejs')">
                      <div class="d-flex flex-row">
                        <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
                          class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                        <div class="pt-1">
                          <p class="fw-bold mb-0">NodeJS</p>
                          <p class="small text-white">Node JavaScript Questions</p>
                        </div>
                      </div>
                    </a>
                  </li>
                  <!-- <li class="p-2">
                    <a href="#!" class="d-flex justify-content-between link-light">
                      <div class="d-flex flex-row">
                        <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-6.webp" alt="avatar"
                          class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                        <div class="pt-1">
                          <p class="fw-bold mb-0">Brad Pitt</p>
                          <p class="small text-white">Lorem ipsum dolor sit.</p>
                        </div>
                      </div>
                      <div class="pt-1">
                        <p class="small text-white mb-1">5 mins ago</p>
                        <span class="text-white float-end"><i class="fas fa-check" aria-hidden="true"></i></span>
                      </div>
                    </a>
                  </li> -->
                </ul>
              </div>
            </div>
    
          </div>
    
          <div class="col-md-6 col-lg-7 col-xl-7">
            <h5 id="current-chatroom-title" class="font-weight-bold mb-3 text-center text-white">General</h5>
            <ul class="list-unstyled text-white">
              <div id="chatroom-messages">

                <li class="d-flex justify-content-between mb-4">
                  <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
                    class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
                  <div class="card mask-custom">
                    <div class="card-header d-flex justify-content-between p-3"
                      style="border-bottom: 1px solid rgba(255,255,255,.3);">
                      <p class="fw-bold mb-0">Brad Pitt</p>
                      <p class="text-light small mb-0"><i class="far fa-clock"></i> 12 mins ago</p>
                    </div>
                    <div class="card-body">
                      <p class="mb-0">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
                        labore et dolore magna aliqua.
                      </p>
                    </div>
                  </div>
                </li>

                <li class="d-flex justify-content-between mb-4">
                  <div class="card mask-custom w-100">
                    <div class="card-header d-flex justify-content-between p-3"
                      style="border-bottom: 1px solid rgba(255,255,255,.3);">
                      <p class="fw-bold mb-0">Lara Croft</p>
                      <p class="text-light small mb-0"><i class="far fa-clock"></i> 13 mins ago</p>
                    </div>
                    <div class="card-body">
                      <p class="mb-0">
                        Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque
                        laudantium.
                      </p>
                    </div>
                  </div>
                  <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
                    class="rounded-circle d-flex align-self-start ms-3 shadow-1-strong" width="60">
                </li>

              </div>


              <li class="mb-3">
                <div class="form-outline form-white">
                  <textarea class="form-control" id="message" rows="1" onfocus="isWriting()" onfocusout="stopWriting()"></textarea>
                  <label class="form-label" for="message" id="writing-label"></label>
                </div>
              </li>
              <button type="button" class="btn btn-light btn-lg btn-rounded float-end" onclick="sendMessageToRoom()">Send</button>
            </ul>
    
          </div>
    
        </div>
    
      </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js">
    </script>
    <script>
      var currentUser = null
      var currentRoom = "news"

      function login() {
        fetch('/auth/validate_user/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                "username": $('#login-username').val(),
                "password": $('#login-password').val()
            })
        })
          .then(response => response.json())
          .then(data => {
            if (data.validated) {
              currentUser = $('#login-username').val()
              $('#login-register-buttons').toggle()
              $('#chatroom').toggle()
              $('#logIn').modal('toggle')
            } else {
              alert("User not validated")
            }
          } );
      }

      function register() {
        fetch('/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                "username": $('#register-username').val(),
                "firstname": $('#register-firstname').val(),
                "lastname": $('#register-lastname').val(),
                "password": $('#register-password').val()
            })
        })
          .then(response => response.json())
          .then(data => {
            if (data.username) {
              currentUser = data.username
              $('#login-register-buttons').toggle()
              $('#chatroom').toggle()
              $('#register').modal('toggle')
            } else {
              alert("Error, user already exists")
            }
          } );
      }

      function renderMessageFromOtherPerson(from, message) {
        return `
        <li class="d-flex justify-content-between mb-4">
          <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
            class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
          <div class="card mask-custom">
            <div class="card-header d-flex justify-content-between p-3"
              style="border-bottom: 1px solid rgba(255,255,255,.3);">
              <p class="fw-bold mb-0">${from}</p>
              <p class="text-light small mb-0"><i class="far fa-clock"></i></p>
            </div>
            <div class="card-body">
              <p class="mb-0">
                ${message}
              </p>
            </div>
          </div>
        </li>
        `
      }

      function renderMessageFromMyself(message) {
        return `
        <li class="d-flex justify-content-between mb-4">
          <div class="card mask-custom w-100">
            <div class="card-header d-flex justify-content-between p-3"
              style="border-bottom: 1px solid rgba(255,255,255,.3);">
              <p class="fw-bold mb-0">${currentUser}</p>
              <p class="text-light small mb-0"><i class="far fa-clock"></i></p>
            </div>
            <div class="card-body">
              <p class="mb-0">
                ${message}
              </p>
            </div>
          </div>
          <img src="https://yt3.ggpht.com/a/AATXAJyAjXWhg85XlBUBufDpYQ7zB7GIiIlg9js4_wCoFA=s900-c-k-c0xffffffff-no-rj-mo" alt="avatar"
            class="rounded-circle d-flex align-self-start ms-3 shadow-1-strong" width="60">
        </li>
        `
      }
      function loadMessages() {
        fetch(`/messages/room/${currentRoom}`)
          .then(response => response.json())
          .then(messages => {
            console.log(messages)
            $("#chatroom-messages").empty()
            for (let message of messages) {
              if (message.from_user == currentUser) {
                $("#chatroom-messages").append(renderMessageFromMyself(message.message))
              } else {
                $("#chatroom-messages").append(renderMessageFromOtherPerson(message.from_user, message.message))
              }
            }
          });
      }

      function selectRoom(room) {
        currentRoom = room
        $('#current-chatroom-title').html(room)
        loadMessages()
      }

      function sendMessageToRoom() {
        fetch('/messages/send_room/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                "from_user": currentUser,
                "room": currentRoom,
                "message": $('#message').val()
            })
        })
          .then(response => response.json())
          .then(data => {
            loadMessages()
            sendMessage()
          });
      }

      function isWriting() {
        client.emit('writing', currentUser)
      } 

      function stopWriting() {
        client.emit('stopWriting', currentUser)
      } 

      loadMessages()
    </script>

    <script src = "/socket.io/socket.io.js"></script>
    
    <script>
      const client = io()

      client.on('messageReceived', () => {
        loadMessages()
      })

      client.on('isWriting', (user) => {
        $("#writing-label").html(`${user} is writing`)
      }) 

      client.on('stopWriting', (user) => {
        $("#writing-label").html("")
      }) 

      function sendMessage(){
          client.emit('messageSent')
      }
  </script>
  </body>
</html>